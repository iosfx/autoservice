datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum MessageType {
  SMS
  WHATSAPP
}

enum MessageStatus {
  SENT
  FAILED
}

enum RetentionRuleType {
  MILEAGE
  TIME
}

model Garage {
  id             String          @id @default(uuid())
  name           String
  timezone       String          @default("UTC")
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  users          User[]
  clients        Client[]
  serviceVisits  ServiceVisit[]
  retentionRules RetentionRule[]
  calendarTokens CalendarToken[]
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  name         String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  garageId     String
  garage       Garage   @relation(fields: [garageId], references: [id], onDelete: Cascade)
}

model Client {
  id            String         @id @default(uuid())
  garageId      String
  name          String
  phone         String
  birthday      DateTime?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  garage        Garage         @relation(fields: [garageId], references: [id], onDelete: Cascade)
  cars          Car[]
  serviceVisits ServiceVisit[]
  messageLogs   MessageLog[]

  @@index([garageId])
  @@index([phone])
}

model Car {
  id              String         @id @default(uuid())
  clientId        String
  licensePlate    String
  vin             String?
  currentMileage  Int            @default(0)
  lastServiceDate DateTime?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  client          Client         @relation(fields: [clientId], references: [id], onDelete: Cascade)
  serviceVisits   ServiceVisit[]

  @@index([clientId])
  @@index([licensePlate])
}

model ServiceVisit {
  id              String    @id @default(uuid())
  garageId        String
  clientId        String
  carId           String?
  calendarEventId String?   @unique
  serviceDate     DateTime
  mileageAtVisit  Int?
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  garage          Garage    @relation(fields: [garageId], references: [id], onDelete: Cascade)
  client          Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  car             Car?      @relation(fields: [carId], references: [id], onDelete: SetNull)

  @@index([garageId])
  @@index([clientId])
  @@index([carId])
  @@index([serviceDate])
}

model RetentionRule {
  id              String            @id @default(uuid())
  garageId        String
  type            RetentionRuleType
  threshold       Int
  messageTemplate String
  isActive        Boolean           @default(true)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  garage          Garage            @relation(fields: [garageId], references: [id], onDelete: Cascade)

  @@index([garageId])
}

model MessageLog {
  id        String        @id @default(uuid())
  clientId  String
  type      MessageType
  content   String
  status    MessageStatus
  sentAt    DateTime      @default(now())
  client    Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([sentAt])
}

model CalendarToken {
  id           String   @id @default(uuid())
  garageId     String
  accessToken  String
  refreshToken String
  expiresAt    DateTime
  calendarId   String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  garage       Garage   @relation(fields: [garageId], references: [id], onDelete: Cascade)

  @@unique([garageId])
}
