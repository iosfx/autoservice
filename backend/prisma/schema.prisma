datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum MessageType {
  SMS
  WHATSAPP
}

enum MessageStatus {
  SENT
  FAILED
}

enum RetentionRuleType {
  MILEAGE
  TIME
}

enum TriggerType {
  APPT_REMINDER
  READY
  FOLLOW_UP
  INACTIVITY
  BIRTHDAY
  SERVICE_DUE_TIME
  SERVICE_DUE_MILEAGE
}

enum MessageChannel {
  SMS
  WHATSAPP
}

enum QueueStatus {
  SCHEDULED
  DUE
  SENDING
  SENT
  FAILED
  CANCELED
  BLOCKED
}

model Garage {
  id              String            @id @default(uuid())
  name            String
  timezone        String            @default("UTC")
  lastSyncAt      DateTime?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  users           User[]
  clients         Client[]
  serviceVisits   ServiceVisit[]
  retentionRules  RetentionRule[]
  calendarTokens  CalendarToken[]
  messageQueue    MessageQueue[]
  messageTemplates MessageTemplate[]
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  name         String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  garageId     String
  garage       Garage   @relation(fields: [garageId], references: [id], onDelete: Cascade)
}

model Client {
  id            String         @id @default(uuid())
  garageId      String
  name          String
  phone         String
  birthday      DateTime?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  garage        Garage         @relation(fields: [garageId], references: [id], onDelete: Cascade)
  cars          Car[]
  serviceVisits ServiceVisit[]
  messageLogs   MessageLog[]
  messageQueue  MessageQueue[]

  @@index([garageId])
  @@index([phone])
}

model Car {
  id              String         @id @default(uuid())
  clientId        String
  licensePlate    String
  vin             String?
  currentMileage  Int            @default(0)
  lastServiceDate DateTime?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  client          Client         @relation(fields: [clientId], references: [id], onDelete: Cascade)
  serviceVisits   ServiceVisit[]
  messageQueue    MessageQueue[]

  @@index([clientId])
  @@index([licensePlate])
}

model ServiceVisit {
  id              String         @id @default(uuid())
  garageId        String
  clientId        String
  carId           String?
  calendarEventId String?        @unique
  serviceDate     DateTime
  mileageAtVisit  Int?
  notes           String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  garage          Garage         @relation(fields: [garageId], references: [id], onDelete: Cascade)
  client          Client         @relation(fields: [clientId], references: [id], onDelete: Cascade)
  car             Car?           @relation(fields: [carId], references: [id], onDelete: SetNull)
  messageQueue    MessageQueue[]

  @@index([garageId])
  @@index([clientId])
  @@index([carId])
  @@index([serviceDate])
}

model RetentionRule {
  id              String            @id @default(uuid())
  garageId        String
  type            RetentionRuleType
  threshold       Int
  messageTemplate String
  isActive        Boolean           @default(true)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  garage          Garage            @relation(fields: [garageId], references: [id], onDelete: Cascade)

  @@index([garageId])
}

model MessageLog {
  id             String        @id @default(uuid())
  clientId       String
  messageQueueId String?
  type           MessageType
  content        String
  status         MessageStatus
  errorMessage   String?
  sentAt         DateTime      @default(now())
  client         Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  messageQueue   MessageQueue? @relation(fields: [messageQueueId], references: [id], onDelete: SetNull)

  @@index([clientId])
  @@index([sentAt])
  @@index([messageQueueId])
}

model MessageQueue {
  id              String        @id @default(uuid())
  garageId        String
  clientId        String
  carId           String?
  serviceVisitId  String?
  triggerType     TriggerType
  channel         MessageChannel
  templateKey     String
  variablesJson   String        @default("{}")
  renderedPreview String?
  scheduledFor    DateTime
  status          QueueStatus   @default(SCHEDULED)
  blockedReason   String?
  lastError       String?
  retryCount      Int           @default(0)
  maxRetries      Int           @default(3)
  sentAt          DateTime?
  canceledAt      DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  garage          Garage        @relation(fields: [garageId], references: [id], onDelete: Cascade)
  client          Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  car             Car?          @relation(fields: [carId], references: [id], onDelete: SetNull)
  serviceVisit    ServiceVisit? @relation(fields: [serviceVisitId], references: [id], onDelete: SetNull)
  messageLogs     MessageLog[]

  @@index([garageId, status, scheduledFor])
  @@index([clientId])
  @@index([scheduledFor])
  @@index([status])
}

model CalendarToken {
  id           String   @id @default(uuid())
  garageId     String
  accessToken  String
  refreshToken String
  expiresAt    DateTime
  calendarId   String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  garage       Garage   @relation(fields: [garageId], references: [id], onDelete: Cascade)

  @@unique([garageId])
}

model MessageTemplate {
  id          String         @id @default(uuid())
  garageId    String
  templateKey String
  triggerType TriggerType
  channel     MessageChannel
  name        String
  body        String
  enabled     Boolean        @default(true)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  garage      Garage         @relation(fields: [garageId], references: [id], onDelete: Cascade)

  @@unique([garageId, templateKey])
  @@index([garageId, triggerType, channel])
  @@index([garageId, enabled])
}
